name: Test Report

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests with JSON reporter
        run: npm run test -- --reporter=json --outputFile=test-results.json || true

      - name: Run tests with coverage
        run: npm run test -- --coverage --reporter=json --outputFile=coverage-results.json || true

      - name: Generate Test Summary
        if: always()
        run: |
          echo "## üìä Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results.json ]; then
            TOTAL=$(cat test-results.json | jq '.numTotalTests // 0')
            PASSED=$(cat test-results.json | jq '.numPassedTests // 0')
            FAILED=$(cat test-results.json | jq '.numFailedTests // 0')

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          else
            echo "Test results not available" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY

          if [ -d coverage ]; then
            echo "Coverage report generated successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results.json
            coverage/
          retention-days: 30

      - name: Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let testSummary = '## üß™ Test Results\n\n';

            try {
              if (fs.existsSync('test-results.json')) {
                const results = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
                testSummary += `| Metric | Count |\n`;
                testSummary += `|--------|-------|\n`;
                testSummary += `| Total Tests | ${results.numTotalTests || 0} |\n`;
                testSummary += `| ‚úÖ Passed | ${results.numPassedTests || 0} |\n`;
                testSummary += `| ‚ùå Failed | ${results.numFailedTests || 0} |\n`;
                testSummary += `| ‚è≠Ô∏è Skipped | ${results.numPendingTests || 0} |\n`;
              } else {
                testSummary += 'Test results not available.\n';
              }
            } catch (e) {
              testSummary += `Error reading test results: ${e.message}\n`;
            }

            testSummary += '\n---\n*Generated by CI/CD Pipeline*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: testSummary
            });
